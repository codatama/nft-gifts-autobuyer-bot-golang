package bot

import (
	"gopkg.in/telebot.v4"

	"context"
	"log"
	"fmt"

	"prvbot/internal/db"
	"prvbot/internal/buttons"
)

func ProtectedStart(c telebot.Context) error {
	ctx := context.Background()
	chatID := c.Chat().ID

	user, err := db.GetUser(ctx, chatID)
	if err != nil {
		log.Printf("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: %v", err)
		return c.Send("‚ùå –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏")
	}

	if user == nil {
		return c.Send("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –±–æ—Ç—É. –î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @exotical")
	}

	return Start(c)
}

func Start(c telebot.Context) error {
	buttons.InitButtons()

	total, err := db.GetTotalBalance(context.Background())
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞:", err)
		total = 0
	}

	text := fmt.Sprintf(
		"–ü—Ä–∏–≤–µ—Ç! –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π *—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π* –∏ *–Ω–æ–≤—ã–π* Telegram-–±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤.\n\n"+
			"–° –Ω–∏–º —Ç—ã *–±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ—Ö* –ø–æ–¥–±–µ—Ä—ë—à—å –∏ –ø—Ä–∏–æ–±—Ä–µ—Ç—ë—à—å –Ω–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏, –∞ –∑–Ω–∞—á–∏—Ç ‚Äî –∏–∑–±–∞–≤–∏—à—å—Å—è –æ—Ç —Å—Ç—Ä–µ—Å—Å–∞ –∏ —Å–º–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ –≤—ã—Å–ø–∞—Ç—å—Å—è.\n\n"+
			"–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç *—É–∂–µ –ø–æ—á—Ç–∏ –≥–æ–¥* –∏ —Å—Ç–∞–ª *–æ–¥–Ω–∏–º –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤* –Ω–∞ —Ä—ã–Ω–∫–µ –ø–æ–¥–∞—Ä–∫–æ–≤.\n\n"+
			"–ù–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –≤ –±–æ—Ç–µ –ª–µ–∂–∏—Ç —Å—É–º–º–∞ –∑–≤—ë–∑–¥ –≤ –±–æ–ª–µ–µ —á–µ–º *%d ‚≠êÔ∏è*!", total)

	return c.Send(text, &telebot.SendOptions{
		ParseMode:   telebot.ModeMarkdown,
		ReplyMarkup: buttons.InlineMenu,
	})
}

func tgbStartMessage() (string, *telebot.SendOptions) {
	buttons.InitButtons()

	total, err := db.GetTotalBalance(context.Background())
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞:", err)
		total = 0
	}

	text := fmt.Sprintf(
		"–ü—Ä–∏–≤–µ—Ç! –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π *—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π* –∏ *–Ω–æ–≤—ã–π* Telegram-–±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤.\n\n"+
			"–° –Ω–∏–º —Ç—ã *–±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ—Ö* –ø–æ–¥–±–µ—Ä—ë—à—å –∏ –ø—Ä–∏–æ–±—Ä–µ—Ç—ë—à—å –Ω–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏, –∞ –∑–Ω–∞—á–∏—Ç ‚Äî –∏–∑–±–∞–≤–∏—à—å—Å—è –æ—Ç —Å—Ç—Ä–µ—Å—Å–∞ –∏ —Å–º–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ –≤—ã—Å–ø–∞—Ç—å—Å—è.\n\n"+
			"–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç *—É–∂–µ –ø–æ—á—Ç–∏ –≥–æ–¥* –∏ —Å—Ç–∞–ª *–æ–¥–Ω–∏–º –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤* –Ω–∞ —Ä—ã–Ω–∫–µ –ø–æ–¥–∞—Ä–∫–æ–≤.\n\n"+
			"–ù–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –≤ –±–æ—Ç–µ –ª–µ–∂–∏—Ç —Å—É–º–º–∞ –∑–≤—ë–∑–¥ –≤ –±–æ–ª–µ–µ —á–µ–º *%d ‚≠êÔ∏è*!", total)

	return text, &telebot.SendOptions{
		ParseMode:   telebot.ModeMarkdown,
		ReplyMarkup: buttons.InlineMenu,
	}
}